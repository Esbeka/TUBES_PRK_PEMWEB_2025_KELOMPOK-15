<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard - Manajemen Kelas Dosen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-3xl font-bold">ðŸ§ª Test Dashboard</h1>
            <p class="text-blue-100">Manajemen Kelas Dosen - Testing Suite</p>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Tests</p>
                        <p class="text-3xl font-bold text-gray-900" id="totalTests">-</p>
                    </div>
                    <i class="fas fa-flask text-4xl text-blue-500 opacity-20"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Passed</p>
                        <p class="text-3xl font-bold text-green-600" id="passedTests">-</p>
                    </div>
                    <i class="fas fa-check-circle text-4xl text-green-500 opacity-20"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Failed</p>
                        <p class="text-3xl font-bold text-red-600" id="failedTests">-</p>
                    </div>
                    <i class="fas fa-times-circle text-4xl text-red-500 opacity-20"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Success Rate</p>
                        <p class="text-3xl font-bold text-purple-600" id="successRate">-</p>
                    </div>
                    <i class="fas fa-chart-pie text-4xl text-purple-500 opacity-20"></i>
                </div>
            </div>
        </div>

        <!-- Run Tests Button -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2">Jalankan Tests</h2>
                    <p class="text-gray-600">Klik tombol di bawah untuk menjalankan full test suite</p>
                </div>
                <button onclick="runTests()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2">
                    <i class="fas fa-play"></i> Run Tests
                </button>
            </div>
            <div id="loadingBar" class="hidden mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 70%;"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Tests sedang berjalan...</p>
            </div>
        </div>

        <!-- Test Results -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- TEST 1 -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-blue-600 text-white p-4">
                    <h3 class="text-lg font-bold">
                        <i class="fas fa-key"></i> TEST 1: Unique Code
                    </h3>
                    <p class="text-blue-100 text-sm">Generate Kode Unik (Tidak Duplikat)</p>
                </div>
                <div class="p-4">
                    <div id="test1" class="space-y-2">
                        <p class="text-gray-600 text-sm">Menunggu test dijalankan...</p>
                    </div>
                </div>
            </div>

            <!-- TEST 2 -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-green-600 text-white p-4">
                    <h3 class="text-lg font-bold">
                        <i class="fas fa-trash"></i> TEST 2: Cascade Delete
                    </h3>
                    <p class="text-green-100 text-sm">Semua Data Terkait Terhapus</p>
                </div>
                <div class="p-4">
                    <div id="test2" class="space-y-2">
                        <p class="text-gray-600 text-sm">Menunggu test dijalankan...</p>
                    </div>
                </div>
            </div>

            <!-- TEST 3 -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-purple-600 text-white p-4">
                    <h3 class="text-lg font-bold">
                        <i class="fas fa-shield-alt"></i> TEST 3: Authorization
                    </h3>
                    <p class="text-purple-100 text-sm">Dosen Lain Tidak Bisa Edit/Hapus</p>
                </div>
                <div class="p-4">
                    <div id="test3" class="space-y-2">
                        <p class="text-gray-600 text-sm">Menunggu test dijalankan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Results -->
        <div class="bg-white rounded-lg shadow mt-8 overflow-hidden">
            <div class="bg-gray-800 text-white p-4">
                <h3 class="text-xl font-bold">
                    <i class="fas fa-list"></i> Detailed Test Results
                </h3>
            </div>
            <div class="p-6">
                <div id="detailedResults" class="space-y-3">
                    <div class="bg-gray-50 p-4 rounded text-center">
                        <p class="text-gray-600">Klik "Run Tests" untuk melihat hasil detail</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation -->
        <div class="bg-white rounded-lg shadow mt-8 p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-book"></i> Dokumentasi
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="../README_KELAS_INTEGRATION.md" class="p-4 border border-blue-200 rounded hover:bg-blue-50 transition">
                    <h4 class="font-bold text-blue-600">README Integration</h4>
                    <p class="text-sm text-gray-600">Informasi lengkap integrasi</p>
                </a>
                <a href="../KELAS_CRUD_DOCUMENTATION.md" class="p-4 border border-green-200 rounded hover:bg-green-50 transition">
                    <h4 class="font-bold text-green-600">API Documentation</h4>
                    <p class="text-sm text-gray-600">Detail API endpoints</p>
                </a>
                <a href="../KELAS_TESTING_GUIDE.md" class="p-4 border border-purple-200 rounded hover:bg-purple-50 transition">
                    <h4 class="font-bold text-purple-600">Testing Guide</h4>
                    <p class="text-sm text-gray-600">Panduan testing lengkap</p>
                </a>
            </div>
        </div>
    </div>

    <script>
        /**
         * Run all tests via AJAX
         */
        async function runTests() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            document.getElementById('loadingBar').classList.remove('hidden');
            resetResults();

            try {
                // Try main test API
                let data = await fetchJSON('../backend/kelas/test-api.php');
                
                // If main fails, try simpler DB check
                if (!data) {
                    console.log('Main API failed, trying DB check...');
                    data = await fetchJSON('../backend/kelas/test-db-check.php');
                }
                
                if (data && data.success) {
                    displayResults(data);
                } else {
                    showError(data?.message || 'Test gagal dijalankan');
                }
            } catch (error) {
                showError('Error: ' + error.message);
                console.error('Full error:', error);
            } finally {
                document.getElementById('loadingBar').classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Fetch and parse JSON with error handling
         */
        async function fetchJSON(endpoint) {
            try {
                const response = await fetch(endpoint);
                const responseText = await response.text();
                
                console.log('Endpoint:', endpoint);
                console.log('Status:', response.status);
                console.log('Response preview:', responseText.substring(0, 200));
                
                return JSON.parse(responseText);
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        /**
         * Display test results
         */
        function displayResults(data) {
            const stats = data.stats || {};
            
            // Update summary stats
            document.getElementById('totalTests').textContent = stats.total || 0;
            document.getElementById('passedTests').textContent = stats.passed || 0;
            document.getElementById('failedTests').textContent = stats.failed || 0;
            document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';

            // Update color based on success rate
            const rateElement = document.getElementById('successRate').parentElement.parentElement;
            if (stats.success_rate === 100) {
                rateElement.querySelector('i').classList.add('text-green-500');
            }

            // Display test categories
            displayTestCategory(data.test1, 'test1', 'blue');
            displayTestCategory(data.test2, 'test2', 'green');
            displayTestCategory(data.test3, 'test3', 'purple');

            // Display detailed results
            displayDetailedResults(data.tests || []);
        }

        /**
         * Display test category results
         */
        function displayTestCategory(tests, elementId, color) {
            const container = document.getElementById(elementId);
            if (!tests || tests.length === 0) return;

            let html = '';
            let passed = 0;
            let total = tests.length;

            tests.forEach((test, idx) => {
                if (test.passed) {
                    passed++;
                    html += `
                        <div class="flex items-start gap-3">
                            <i class="fas fa-check-circle text-green-600 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-900">Test ${idx + 1}: ${test.name}</p>
                                <p class="text-sm text-gray-600">${test.message}</p>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="flex items-start gap-3">
                            <i class="fas fa-times-circle text-red-600 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-900">Test ${idx + 1}: ${test.name}</p>
                                <p class="text-sm text-red-600">${test.message}</p>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = `
                <div class="mb-2">
                    <span class="inline-block bg-${color}-100 text-${color}-800 px-3 py-1 rounded-full text-sm font-semibold">
                        ${passed}/${total} Passed
                    </span>
                </div>
                ${html}
            `;
        }

        /**
         * Display all test results in detail
         */
        function displayDetailedResults(tests) {
            const container = document.getElementById('detailedResults');
            
            if (!tests || tests.length === 0) {
                container.innerHTML = '<p class="text-gray-600">Tidak ada hasil test</p>';
                return;
            }

            let html = '<table class="w-full">';
            html += '<thead><tr class="bg-gray-100"><th class="px-4 py-2 text-left font-bold">No</th><th class="px-4 py-2 text-left font-bold">Test Name</th><th class="px-4 py-2 text-left font-bold">Status</th><th class="px-4 py-2 text-left font-bold">Message</th></tr></thead>';
            html += '<tbody>';

            tests.forEach((test, idx) => {
                const statusClass = test.passed ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                const statusText = test.passed ? 'âœ“ PASSED' : 'âœ— FAILED';
                const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                html += `
                    <tr class="${bgClass} border-b">
                        <td class="px-4 py-3">${idx + 1}</td>
                        <td class="px-4 py-3">${test.name}</td>
                        <td class="px-4 py-3"><span class="${statusClass}">${statusText}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-600">${test.message}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /**
         * Reset results
         */
        function resetResults() {
            document.getElementById('totalTests').textContent = '-';
            document.getElementById('passedTests').textContent = '-';
            document.getElementById('failedTests').textContent = '-';
            document.getElementById('successRate').textContent = '-';

            document.getElementById('test1').innerHTML = '<p class="text-gray-600 text-sm">Menjalankan test...</p>';
            document.getElementById('test2').innerHTML = '<p class="text-gray-600 text-sm">Menjalankan test...</p>';
            document.getElementById('test3').innerHTML = '<p class="text-gray-600 text-sm">Menjalankan test...</p>';

            document.getElementById('detailedResults').innerHTML = '<p class="text-gray-600">Menjalankan test...</p>';
        }

        /**
         * Show error message
         */
        function showError(message) {
            const container = document.getElementById('detailedResults');
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded p-4">
                    <p class="text-red-800 font-bold">
                        <i class="fas fa-exclamation-circle"></i> Error: ${message}
                    </p>
                </div>
            `;
        }
    </script>
</body>
</html>
